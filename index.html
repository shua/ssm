<html>
<head>
<link rel="icon" type="image/png" href="ssm_b.png"/>
<meta http-equiv="Content-Security-Policy" content="default-src *; style-src 'self' 'unsafe-inline'; script-src 'self' 'unsafe-inline' 'unsafe-eval'">
<meta name="viewport" content="width=device-width, initial-scale=1.0">
<link type="text/css" rel="stylesheet" href="style.css"/>
<script src="cmdline.js"></script>
<script src="stream.js"></script>
<script src="https://player.twitch.tv/js/embed/v1.js"></script>
<script>
function addstream(div) {
	ct = document.getElementsByClassName("container")[0]
	ct.appendChild(div)
	if(strs.length !== 0) strs[cur].id=""
	if(div.mute == null) div.mute = () => true
	if(div.play == null) div.play = () => true
	cur = strs.push(div) - 1
	div.id="cur"
	setcurmaster()
}

window.onload = function() {
	initcmdline()
	inityt()
	handleKeyKEY = handlekey
	helpstr = document.getElementsByClassName("help")[0]
	helpstr.mute = () => true
	helpstr.play = () => true
}
function handlekey(k) {
	switch (k) {
	case ":":
		cmdline.focus()
		break
	case "j":
		focusnext(1)
		break
	case "k":
		focusnext(-1)
		break
	case "t":
		togglelayout()
		break
	case "m":
		mute()
		break
	case "M":
		strs[cur].mute()
		break
	case "p":
		strs[cur].play()
		break
	case "P":
		play()
		break
	case "q":
		cmdline.focus()
		cmdline.value = ":"
		break
	case " ":
		setcurmaster()
		break
	}
}
cmds = {
	"youtube": function(args) {
		console.log("yt", args)
		addyt(args[0])
	},
	"twitch": function(args) {
		addtw(args[0])
	},
	"birds": function(args) {
		morebirds()
	},
	"quit": function(args) {
		if(strs.length > 0)
			kill(cur)
	},
	"help": function(args) {
		if(helpstr.parentElement == null)
			addstream(helpstr)
	}
}
cmds["yt"] = cmds["youtube"]
var cur = 0
var strs = new Array();
var num_master = 1
var helpstr
function focusnext(dir) {
	if (strs.length === 0) return
	if(cur >= 0 && cur < strs.length)
		strs[cur].id = ""
	cur += dir;
	if (cur < 0) cur = strs.length - 1
	if (cur >= strs.length) cur = 0
	strs[cur].id = "cur"
}
function setcurmaster() {
	if(!strs[cur].classList.contains("master")) {
		pm = strs[num_master-1]
		pm.mute(true)
	}
	i = strs[cur]
	strs.splice(cur, 1)
	strs.unshift(i)
	i.mute(false)
	cur = 0
	arrange()
}
function arrange() {
	for(let i=0; i<strs.length; i++) {
		if(i < num_master)
			strs[i].classList.add("master")
		else
			strs[i].classList.remove("master")
		strs[i].style.order=i
	}
	if(strs.length <= num_master)
		document.body.classList.add("max")
	else
		document.body.classList.remove("max")
	if(strs.length === 1)
		document.body.classList.add("solo")
	else
		document.body.classList.remove("solo")
}
function togglelayout() {
	b = document.body.classList
	f = h = "horz"
	t = v = "vert"
	if(!b.contains(h)) {
		f = v
		t = h
	}
	if(b.contains(f))
		b.remove(f)
	b.add(t)
}
function mute() {
	for(s in strs)
		strs[s].mute(!(s < num_master && mute.ismuted))
	mute.ismuted = !mute.ismuted
}
mute.ismuted = false
function play() {
	play.isplaying = !play.isplaying
	for(s in strs)
		strs[s].play(play.isplaying)
}
play.isplaying = true
function kill(i) {
	t = strs[i]
	t.parentNode.removeChild(t)
	strs.splice(i,1)
	cur--; focusnext(1)
	arrange()
}

function morebirds() {
	cmds["youtube"](["u9Sk6-LIvDc"])
	cmds["youtube"](["JfXiBkL9U5s"])
	cmds["youtube"](["qF6YkiJXfEA"])
	cmds["youtube"](["IiFSeJhHMgY"])
}

</script>
</head>
<body class="max solo horz">
<input type="text" tabindex="-1" class="cmdline"/>
<div class="container">
<div class="stream help master" id="cur">
	<img src="ssm_w.png"/>
	<p>
	As of right now, the cmdline can be brought up by 
	pressing <code>:</code> 
	<br/>and this window can be closed by pressing
	<code>q+RETURN</code>
	</p>
	<h1>What is this?</h1>
	<p>ssm is a simple stream manager inspired by <a href="http://multitwitch.tv">multitwitch</a>, <a href="http://dwm.suckless.org">dwm</a>, and <a href="https://en.wikipedia.org/wiki/Vi">vi</a></p>
	<h1>Available commands are</h1>
<pre><code>youtube VIDEOID open youtube live stream with VIDEOID
twitch CHANNEL  open twitch live stream at CHANNEL
help            open this help box
quit            close currently selected stream
</code></pre>
	<p> you may find...things, by looking at the source for this page</p>

	<h1>Available keybindings are </h1>
<pre><code>j/k   cycle through open streams
q     opens cmdline to close selected stream (you just need to press enter)
SPACE set selected stream as master
</code></pre>

<br/>
<p>
Todo:
<ul>
<li>test on other browsers</li>
<li>h/l for increase/decrease master size</li>
<li>H/L for increase/decrease num_master</li>
<li>hitbox embeds (though API doesn't support play/pause and mute/unmute)</li>
<li>chat embeds (have to think about this, will they go alongside the stream, or be their own?)</li>
<li>grid layout (will probably require javascript instead of flex)
</ul>
</p>
<p>
Bugs:
<ul>
<li>keyboard gets eaten by iframes, click on border to get back</li>
<li>cmdline gets cleared when switching to newtab</li>
<li>firefox and chrome behave differently on ':' press; chrome passes the button to the input, but firefox doesn't</li>
</ul>
</p>
</div>
<script>strs.push.apply(strs, document.getElementsByClassName("help"))</script>
</div>
</body>
</html>