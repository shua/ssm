<html>
<head>
<link rel="icon" type="image/png" href="ssm_b.png"/>
<meta name="viewport" content="width=device-width, initial-scale=1.0">
<link type="text/css" rel="stylesheet" href="style.css"/>
<script src="cmdline.js"></script>
<script src="stream.js"></script>
<script src="http://player.twitch.tv/js/embed/v1.js"></script>
<script>

function addtw(ch) {
	console.log(ch)
	str=document.createElement("div")
	str.classList.add("stream")
	div=document.createElement("div")
	div.id=uniqpid()
	str.appendChild(div)
	str.mute = function(m) {
		if(this.player == null) return
		if(arguments.length === 0)
			m = !this.player.getMuted()
		this.player.setMuted(m)
	}
	str.play = function(p) {
		if(this.player == null) return
		if(arguments.length === 0)
			p = this.player.isPaused()
		console.log(p)
		if(p)
			this.player.play()
		else
			this.player.pause()
	}
	addstream(str)
	str.player = twframe(ch, div.id)
}

function twframe(ch, pid) {
	return new Twitch.Player(pid, {
		width: '',
		height: '',
		channel: ch
	})
}

function addstream(div) {
	ct = document.getElementsByClassName("container")[0]
	ct.appendChild(div)
	if(strs.length !== 0) strs[cur].id=""
	cur = strs.push(div) - 1
	div.id="cur"
	setcurmaster()
}

window.onload = function() {
	initcmdline()
	inityt()
}
function handleKeyKEY(k) {
	switch (k) {
	case ":":
		cmdline.focus()
		break
	case "j":
		focusnext(1)
		break
	case "k":
		focusnext(-1)
		break
	case "t":
		togglelayout()
		break
	case "m":
		mute()
		break
	case "M":
		strs[cur].mute()
		break
	case "p":
		strs[cur].play()
		break
	case "P":
		play()
		break
	case "q":
		cmdline.focus()
		cmdline.value = ":"
		break
	case " ":
		setcurmaster()
		break
	}
}
cmds = {
	"youtube": function(args) {
		console.log("yt", args)
		addyt(args[0])
	},
	"twitch": function(args) {
		addtw(args[0])
	},
	"birds": function(args) {
		morebirds()
	},
	"quit": function(args) {
		if(strs.length > 0)
			kill(cur)
	}
}
cmds["yt"] = cmds["youtube"]
var cur = 0
var strs = new Array();
var num_master = 1
function focusnext(dir) {
	if (strs.length === 0) return
	strs[cur].id = ""
	cur += dir;
	if (cur < 0) cur = strs.length - 1
	if (cur >= strs.length) cur = 0
	strs[cur].id = "cur"
}
function setcurmaster() {
	if(!strs[cur].classList.contains("master")) {
		pm = strs[num_master-1]
		pm.mute(true)
	}
	i = strs[cur]
	strs.splice(cur, 1)
	strs.unshift(i)
	i.mute(false)
	cur = 0
	arrange()
}
function arrange() {
	for(let i=0; i<strs.length; i++) {
		if(i < num_master)
			strs[i].classList.add("master")
		else
			strs[i].classList.remove("master")
		strs[i].style.order=i
	}
	if(strs.length <= num_master)
		document.body.classList.add("max")
	else
		document.body.classList.remove("max")
}
function togglelayout() {
	b = document.body.classList
	f = h = "horz"
	t = v = "vert"
	if(!b.contains(h)) {
		f = v
		t = h
	}
	if(b.contains(f))
		b.remove(f)
	b.add(t)
}
function mute() {
	for(s in strs)
		strs[s].mute(!(s < num_master && mute.ismuted))
	mute.ismuted = !mute.ismuted
}
mute.ismuted = false
function play() {
	play.isplaying = !play.isplaying
	for(s in strs)
		strs[s].play()
}
play.isplaying = true
function kill(i) {
	t = strs[i]
	t.parentNode.removeChild(t)
	strs.splice(i,1)
	arrange()
}

function morebirds() {
	cmds["youtube"](["u9Sk6-LIvDc"])
	cmds["youtube"](["JfXiBkL9U5s"])
	cmds["youtube"](["qF6YkiJXfEA"])
	cmds["youtube"](["IiFSeJhHMgY"])
}

</script>
</head>
<body class="max horz">
<input type="text" tabindex="-1" class="cmdline"/>
<div class="container">
<div class="stream help master">
	<img src="ssm_w.png"/>
	<p>As of right now, the cmdline can be brought up by pressing <code>:</code></p>
	<p>Available commands are</p>
<pre><code>youtube VIDEOID
twitch CHANNEL
quit
</code></pre>
	<p> you may find...things, by looking at the source for this page</p>

<br/>
	<p>Available keybindings are </p>
<pre><code>j/k   cycle through open streams
q     opens cmdline to close selected stream (you just need to press enter)
SPACE set selected stream as master
</code></pre>

<br/>
<p>
Todo:
<ul>
<li>h/l for increase/decrease master size</li>
<li>H/L for increase/decrease num_master</li>
<li>hitbox embeds (though API doesn't support play/pause and mute/unmute)</li>
<li>grid layout (will probably require javascript instead of flex)
</ul>
</p>
</div>
<script>strs.push.apply(strs, document.getElementsByClassName("help"))</script>
</div>
</body>
</html>